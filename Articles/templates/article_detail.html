<!-- templates/articles/article_detail.html -->
{% extends 'layout.html' %}

{% block title %}{{ article.title }} - TheFlipperEconomics{% endblock %}

{% block content %}
    <article class="container my-4">
        <h1 class="mb-3">{{ article.title }}</h1>
        <p>Written by Admin on {{ article.pub_date|date:"F d, Y" }}</p>
        
        {% if article.image %}
            <img src="{{ article.image.url }}" alt="{{ article.title }}" class="img-fluid mb-3">
        {% endif %}
        
        <p>{{ article.content|safe }}</p>

        {% if is_last_article %}
            <!-- Display predefined Pcode for the last article -->
            <p class="mb-3"><strong>Pcode:</strong> 12345</p>
        {% endif %}    

        {% if next_article %}
            <div id="nextButtonContainer" style="display: none;">
                <button id="nextButton" class="btn btn-primary">Next</button>
            </div>

            <p id="timerText" style="display: none;">Next article in <span id="timerCountdown"></span> seconds</p>

            <script>
                // Set a timeout for 20 seconds
                const countdownDuration = 20;
                let countdown = countdownDuration;
            
                const timerText = document.getElementById('timerText');
                const timerCountdown = document.getElementById('timerCountdown');
                const nextButtonContainer = document.getElementById('nextButtonContainer');
                const nextButton = document.getElementById('nextButton');
            
                const countdownInterval = setInterval(function () {
                    countdown--;
            
                    // Display the timer text and countdown
                    timerText.style.display = 'block';
                    timerCountdown.innerText = countdown;
            
                    // If the countdown reaches 0, display the "Next" button
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        timerText.style.display = 'none';
                        nextButtonContainer.style.display = 'block';
                    }
                }, 1000);
            
                // Function to handle ad click
                function handleAdClick() {
                    // Perform actions specific to ad click tracking
                    console.log('Ad clicked');
                    // Store the ad click instance in the session
                    sessionStorage.setItem('adClickInstance', 'clicked');
                }

                // Function to handle next button click
                function handleNextButtonClick() {
                    // Redirect to the URL of the next article
                    window.location.href = '{% url 'article_detail' slug=next_article.slug %}';
                }
            
                // Add an event listener to the Next button for redirection
                nextButton.addEventListener('click', function () {
                    handleAdClick();  // Call the function for ad click tracking
                    handleNextButtonClick();  // Call the function for next button click
                });
            </script>
        {% else %}
            <!-- SproutGigs PCODE Generation -->
            {% if job_id and worker_id and is_last_article %}
            <div class="mb-4">
                <p class="mb-3"><strong>PCODE:</strong> <a href="{% url 'generate_pcode' %}?job={{ job_id }}&worker={{ worker_id }}" target="_blank">Generate PCODE</a></p>
            </div>    
            {% endif %}            
        {% endif %}
    </article>
{% endblock %}
